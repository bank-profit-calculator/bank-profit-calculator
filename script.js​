// بيانات البنوك وشهاداتها
const bankCertificates = [
  {
    bank: "البنك الأهلي المصري",
    certificates: [
      { name: "شهادة القمة", rate: 19, type: "ثابت", pros: "عائد مرتفع مع إمكانية السحب الشهري", cons: "لا يوجد تجديد تلقائي بعد 6 أشهر" },
      { name: "شهادة النور", rate: 17, type: "ثابت", pros: "عائد ثابت لمدة عام كامل", cons: "لا يوجد سحب مبكر" },
      { name: "شهادة الادخار الشهرية", rate: 13, type: "ثابت", pros: "سحب شهري (لا يفقد رأس المال)", cons: "معدل عائد أقل من الشهادات الأخرى" }
    ]
  },
  {
    bank: "بنك مصر الدولي",
    certificates: [
      { name: "شهادة الاستثمار", rate: 18.5, type: "ثابت", pros: "عائد مرتفع لمدة عام", cons: "غرامة عند السحب قبل التاريخ المحدد" },
      { name: "شهادة التوفير", rate: 16.5, type: "ثابت", pros: "تجديد تلقائي كل 6 أشهر", cons: "لا يمكن السحب قبل 3 أشهر" },
      { name: "شهادة توفير 6 أشهر", rate: 12.75, type: "ثابت", pros: "مرونة في مدة الاستثمار", cons: "لا يوجد تجديد تلقائي" }
    ]
  },
  {
    bank: "بنك القاهرة",
    certificates: [
      { name: "شهادة الأمان", rate: 18, type: "ثابت", pros: "إمكانية السحب بعد 3 أشهر", cons: "لا يوجد تجديد تلقائي" },
      { name: "شهادة المستقبل", rate: 15, type: "ثابت", pros: "تجديد تلقائي كل 3 أشهر", cons: "عائد أقل من المنافسين" },
      { name: "شهادة التوفير المميزة", rate: 13.5, type: "ثابت", pros: "إمكانية السحب في أي وقت", cons: "عائد منخفض نسبياً" }
    ]
  },
  {
    bank: "CIB - البنك التجاري الدولي",
    certificates: [
      { name: "شهادة Wealth", rate: 20, type: "ثابت", pros: "أعلى عائد في السوق حالياً", cons: "حد أدنى 100 ألف جنيه" },
      { name: "شهادة CIB", rate: 14, type: "ثابت", pros: "تجديد تلقائي كل 6 أشهر", cons: "لا يمكن السحب مبكراً" }
    ]
  },
  {
    bank: "QNB الأهلي",
    certificates: [
      { name: "شهادة التوفير الذهبية", rate: 17.5, type: "ثابت", pros: "إمكانية السحب بعد 3 أشهر", cons: "لا يوجد تجديد تلقائي بعد 6 أشهر" },
      { name: "شهادة QNB الاستثمارية", rate: 14.25, type: "ثابت", pros: "تجديد تلقائي كل 3 أشهر", cons: "عائد أقل من المنافسين" }
    ]
  },
  {
    bank: "بنك الإسكندرية",
    certificates: [
      { name: "شهادة التوفير المميز", rate: 16.25, type: "ثابت", pros: "إمكانية السحب بعد شهر واحد", cons: "عائد أقل من المتوسط" },
      { name: "شهادة المستقبل", rate: 13.75, type: "ثابت", pros: "تجديد تلقائي كل 6 أشهر", cons: "لا يمكن السحب مبكراً" }
    ]
  },
  {
    bank: "البنك الزراعي",
    certificates: [
      { name: "شهادة النور", rate: 18.25, type: "ثابت", pros: "عائد ثابت لمدة عام كامل", cons: "لا يوجد تجديد تلقائي" },
      { name: "شهادة التوفير", rate: 6.5, type: "متغير", pros: "عائد متغير حسب سعر الفائدة", cons: "عائد غير مضمون على المدى الطويل" }
    ]
  }
];

// تعبئة قائمة البنوك
function populateBanks() {
  const bankSelect = document.getElementById("bank");
  bankCertificates.forEach(bank => {
    const option = document.createElement("option");
    option.value = bank.bank;
    option.textContent = bank.bank;
    bankSelect.appendChild(option);
  });
}

// تحديث الشهادات حسب البنك المختار
function updateCertificates() {
  const bankName = document.getElementById("bank").value;
  const certificateSelect = document.getElementById("certificate");
  const selectedFilter = document.querySelector('input[name="filterType"]:checked')?.value;

  certificateSelect.innerHTML = "<option disabled selected>اختر الشهادة / العائد</option>";

  const selectedBank = bankCertificates.find(bank => bank.bank === bankName);

  if (selectedBank) {
    let filteredCertificates = selectedBank.certificates;

    if (selectedFilter !== "all") {
      filteredCertificates = filteredCertificates.filter(cert => cert.type === selectedFilter);
    }

    filteredCertificates.forEach(cert => {
      const option = document.createElement("option");
      option.value = cert.name;
      option.textContent = `${cert.name} (${cert.type})`;
      certificateSelect.appendChild(option);
    });
  }
}

// تعيين نسبة العائد عند اختيار شهادة
function setRateFromCertificate() {
  const bankName = document.getElementById("bank").value;
  const certName = document.getElementById("certificate").value;
  const rateInput = document.getElementById("rate");

  const selectedBank = bankCertificates.find(bank => bank.bank === bankName);
  const selectedCert = selectedBank?.certificates.find(cert => cert.name === certName);

  if (selectedCert) {
    rateInput.value = selectedCert.rate;
  }
}

// حساب العائد
function calculateInterest() {
  let amount = parseFloat(document.getElementById("amount").value);
  let rate = parseFloat(document.getElementById("rate").value);
  let period = document.querySelector('input[name="period"]:checked')?.value;
  let currency = document.getElementById("currency").value;

  if (isNaN(amount) || isNaN(rate) || !period) {
    document.getElementById("result").textContent = "الرجاء إدخال جميع البيانات المطلوبة";
    return;
  }

  let yearlyInterest = (amount * rate) / 100;
  let result;

  if (period === "daily") {
    result = yearlyInterest / 365;
  } else if (period === "monthly") {
    result = yearlyInterest / 12;
  } else {
    result = yearlyInterest;
  }

  document.getElementById("result").textContent =
    `العائد ${getPeriodName(period)}: ${result.toFixed(2)} ${getCurrencySymbol(currency)}`;
}

// الحصول على اسم الفترة
function getPeriodName(value) {
  switch (value) {
    case 'daily': return 'اليومي';
    case 'monthly': return 'الشهري';
    case 'yearly': return 'السنوي';
    default: return '';
  }
}

// الحصول على رمز العملة
function getCurrencySymbol(code) {
  switch (code) {
    case 'EGP': return 'جنيه';
    case 'USD': return '$';
    case 'SAR': return 'ر.س';
    case 'EUR': return '€';
    default: return '';
  }
}

// تبديل المظهر
function toggleTheme() {
  document.body.classList.toggle('dark');
  const btn = document.getElementById("toggleTheme");
  btn.textContent = document.body.classList.contains("dark") ? "تبديل المظهر الفاتح" : "تبديل المظهر الداكن";
}

// بناء جدول المقارنة
function buildComparisonTable() {
  const tbody = document.querySelector("#comparisonTable tbody");
  tbody.innerHTML = "";

  bankCertificates.forEach(bank => {
    bank.certificates.forEach(cert => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${bank.bank}</td>
        <td>${cert.name}</td>
        <td>${cert.type}</td>
        <td>${cert.rate}%</td>
        <td><button onclick="useCertificate('${bank.bank}', '${cert.name}')">استخدم</button></td>
      `;
      tbody.appendChild(row);
    });
  });
}

// استخدام شهادة محددة
function useCertificate(bankName, certName) {
  document.getElementById("bank").value = bankName;
  updateCertificates();
  setTimeout(() => {
    document.getElementById("certificate").value = certName;
    setRateFromCertificate();
    window.scrollTo({ top: 0, behavior: "smooth" });
  }, 200);
}

// تحميل PDF للمقارنة
function downloadComparisonPDF() {
  const table = document.getElementById("advancedComparisonTable");
  const options = {
    margin: 0.5,
    filename: 'مقارنة_الشهادات_البنكية.pdf',
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2 },
    jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
  };
  html2pdf().set(options).from(table).save();
}

// مشاركة على واتساب
function shareOnWhatsApp() {
  const rows = document.querySelectorAll("#advancedComparisonTable tbody tr");
  if (rows.length === 0) {
    alert("لا توجد بيانات متاحة للمشاركة حالياً.");
    return;
  }

  let message = "مقارنة الشهادات البنكية:\n\n";
  rows.forEach(row => {
    const cells = row.querySelectorAll("td");
    message += `البنك: ${cells[0].textContent}\n`;
    message += `الشهادة: ${cells[1].textContent}\n`;
    message += `النوع: ${cells[2].textContent}\n`;
    message += `المميزات: ${cells[3].textContent}\n`;
    message += `العيوب: ${cells[4].textContent}\n`;
    message += `العائد: ${cells[5].textContent}\n`;
    message += "------------------------\n";
  });

  const encodedMessage = encodeURIComponent(message);
  const whatsappURL = `https://wa.me/?text=${encodedMessage}`;
  window.open(whatsappURL, "_blank");
}

// تصفية جدول المقارنة المتقدم
function filterAdvancedComparison() {
  const type = document.getElementById("multiFilterType").value;
  const selectedBanks = Array.from(document.querySelectorAll('#multiBankFilter input:checked')).map(cb => cb.value);
  const table = document.querySelector("#advancedComparisonTable tbody");
  table.innerHTML = "";

  bankCertificates.forEach(item => {
    if (selectedBanks.length > 0 && !selectedBanks.includes(item.bank)) return;

    item.certificates.forEach(cert => {
      if (type !== "all" && cert.type !== type) return;

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${item.bank}</td>
        <td>${cert.name}</td>
        <td>${cert.type}</td>
        <td>${cert.pros || "—"}</td>
        <td>${cert.cons || "—"}</td>
        <td>${cert.rate}%</td>
      `;
      table.appendChild(row);
    });
  });
}

// تعبئة فلتر البنوك المتعدد
function populateMultiBankFilter() {
  const container = document.getElementById("multiBankFilter");
  container.innerHTML = "";
  bankCertificates.forEach(bank => {
    const label = document.createElement("label");
    label.innerHTML = `<input type="checkbox" value="${bank.bank}"> ${bank.bank}`;
    container.appendChild(label);
  });
}

// تهيئة الصفحة عند التحميل
window.onload = function () {
  populateBanks();
  buildComparisonTable();
  populateMultiBankFilter();
};
